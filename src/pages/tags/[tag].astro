---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPublishedArticles } from '../../utils/collections';
import { getCategoryDef } from '../../data/taxonomy';

export async function getStaticPaths() {
  const articles = await getPublishedArticles();
  const tags = new Set<string>();
  articles.forEach((a) => a.data.tags.forEach((t) => tags.add(t)));

  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      tag,
      articles: articles.filter((a) => a.data.tags.includes(tag)),
    },
  }));
}

const { tag, articles } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`} description={`Articles tagged with ${tag}`}>
  <style>
    .tag-page { max-width: 700px; margin: 0 auto; padding: 60px 28px; }
    .tag-page h1 { margin-bottom: 8px; }
    .tag-page .count { color: var(--text-dim); font-size: 14px; margin-bottom: 32px; }
    .article-list { display: flex; flex-direction: column; gap: 12px; }
    .article-item {
      display: block;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.15s;
    }
    .article-item:hover {
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }
    .item-cat { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
    .item-title { font-size: 15px; font-weight: 700; }
    .item-desc { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  </style>

  <div class="tag-page">
    <a href="/knowledge-base/" style="font-size: 13px; color: var(--text-dim);">‚Üê Knowledge Base</a>
    <h1 class="text-gradient">#{tag}</h1>
    <p class="count">{articles.length} article{articles.length !== 1 ? 's' : ''}</p>

    <div class="article-list">
      {articles.map((article) => {
        const catDef = getCategoryDef(article.data.category);
        return (
          <a href={`/knowledge-base/knowledge/${article.id.replace(/\.md$/, '')}/`} class="article-item">
            <div class="item-cat" style={`color: ${catDef.color}`}>{catDef.labelJa}</div>
            <div class="item-title">{article.data.title}</div>
            <div class="item-desc">{article.data.description}</div>
          </a>
        );
      })}
    </div>
  </div>
</BaseLayout>
