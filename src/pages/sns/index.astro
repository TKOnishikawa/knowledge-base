---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Search from '../../components/Search.astro';
import SNSCard from '../../components/SNSCard.astro';
import { getAllSNSContent, getUniqueTopics } from '../../utils/sns-collections';
import { contentTypes, statusConfig } from '../../data/sns-taxonomy';

const items = await getAllSNSContent();
const topics = getUniqueTopics(items);
const typeEntries = Object.entries(contentTypes);
const statusEntries = Object.entries(statusConfig);

// Stats
const byType: Record<string, number> = {};
const byStatus: Record<string, number> = {};
for (const item of items) {
  byType[item.data.contentType] = (byType[item.data.contentType] ?? 0) + 1;
  byStatus[item.data.status] = (byStatus[item.data.status] ?? 0) + 1;
}

// This week count
const now = new Date();
const weekStart = new Date(now);
weekStart.setDate(now.getDate() - now.getDay() + 1); // Monday
weekStart.setHours(0, 0, 0, 0);
const thisWeekCount = items.filter(i => {
  const d = i.data.publishDate ?? i.data.date;
  return d >= weekStart && i.data.status === 'published';
}).length;
---

<BaseLayout title="SNS Portal" description="SNS content accumulation & review portal">
  <style>
    .hero {
      text-align: center;
      padding: 60px 0 32px;
    }
    .hero h1 {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 6px;
    }
    .hero .sub {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 32px;
    }

    .stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 28px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .stats .stat {
      text-align: center;
    }
    .stats .num {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      display: block;
    }

    .nav-links {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 28px;
    }
    .nav-link {
      font-size: 12px;
      color: var(--cyan);
      text-decoration: none;
      padding: 6px 14px;
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: 16px;
      transition: all 0.15s;
    }
    .nav-link:hover {
      background: rgba(34, 211, 238, 0.06);
      border-color: var(--cyan);
    }

    .filter-section {
      margin-bottom: 12px;
    }
    .filter-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 6px;
      text-align: center;
    }
    .filter-bar {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .filter-btn {
      padding: 5px 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: transparent;
      color: var(--text-dim);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: var(--font-sans);
      white-space: nowrap;
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--btn-color, var(--cyan));
      color: var(--btn-color, var(--cyan));
      background: rgba(34, 211, 238, 0.06);
    }
    .filter-btn .icon {
      margin-right: 4px;
    }

    .content-stream {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 700px;
      margin: 24px auto 0;
    }

    .empty {
      text-align: center;
      padding: 60px;
      color: var(--text-muted);
    }

    .footer {
      text-align: center;
      padding: 60px 0;
      font-size: 10px;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .stats {
        gap: 12px;
      }
      .stats .num {
        font-size: 16px;
      }
      .filter-bar {
        justify-content: flex-start;
        padding-bottom: 4px;
      }
    }
  </style>

  <div class="container">
    <div class="hero">
      <div class="badge">SNS Portal</div>
      <h1 class="text-gradient">SNS Portal</h1>
      <p class="sub">Content accumulation & review</p>
    </div>

    <div class="stats">
      <div class="stat"><span class="num">{items.length}</span> total</div>
      {typeEntries.map(([key, def]) => (
        byType[key] ? (
          <div class="stat">
            <span class="num" style={`color: ${def.color}`}>{byType[key]}</span>
            <span>{def.icon} {def.label}</span>
          </div>
        ) : null
      ))}
      <div class="stat"><span class="num" style="color: var(--green)">{thisWeekCount}</span> this week</div>
    </div>

    <div class="nav-links">
      <a href="/knowledge-base/sns/calendar/" class="nav-link">Calendar View</a>
      <a href="/knowledge-base/knowledge/sns-master-strategy/" class="nav-link">Strategy Master</a>
      <a href="/knowledge-base/" class="nav-link">Knowledge Base</a>
    </div>

    <Search />

    <!-- Content Type filter -->
    <div class="filter-section">
      <div class="filter-bar">
        <button class="filter-btn active" data-type="all" style="--btn-color: var(--cyan)">All</button>
        {typeEntries.map(([key, def]) => (
          <button class="filter-btn" data-type={key} style={`--btn-color: ${def.color}`}>
            <span class="icon">{def.icon}</span>{def.label}
          </button>
        ))}
      </div>
    </div>

    <!-- Status filter -->
    <div class="filter-section">
      <div class="filter-bar">
        <button class="filter-btn active" data-status="all" style="--btn-color: var(--cyan)">All Status</button>
        {statusEntries.map(([key, def]) => (
          <button class="filter-btn" data-status={key} style={`--btn-color: ${def.color}`}>
            {def.label}
          </button>
        ))}
      </div>
    </div>

    <div class="content-stream" id="content-stream">
      {items.length === 0 && (
        <div class="empty">No content yet. Start by adding files to src/content/sns-content/</div>
      )}
      {items.map((item) => (
        <SNSCard item={item} />
      ))}
    </div>

    <div class="footer">SNS Portal â€” Content Accumulation & Review</div>
  </div>

  <script>
    let activeType = 'all';
    let activeStatus = 'all';

    function applyFilters() {
      document.querySelectorAll('.sns-card').forEach(card => {
        const el = card as HTMLElement;
        const type = el.getAttribute('data-content-type');
        const status = el.getAttribute('data-status');
        const matchType = activeType === 'all' || type === activeType;
        const matchStatus = activeStatus === 'all' || status === activeStatus;
        el.style.display = (matchType && matchStatus) ? '' : 'none';
      });
    }

    document.querySelectorAll('[data-type]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeType = btn.getAttribute('data-type') ?? 'all';
        applyFilters();
      });
    });

    document.querySelectorAll('[data-status]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-status]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeStatus = btn.getAttribute('data-status') ?? 'all';
        applyFilters();
      });
    });
  </script>
</BaseLayout>
