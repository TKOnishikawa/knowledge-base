---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllSNSContent } from '../../utils/sns-collections';
import { getContentTypeDef, statusConfig } from '../../data/sns-taxonomy';

const items = await getAllSNSContent();

// Current month (build time)
const now = new Date();
const year = now.getFullYear();
const month = now.getMonth(); // 0-indexed

const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'];
const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

// Build calendar grid
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const daysInMonth = lastDay.getDate();

// Monday=0 offset (JS getDay: 0=Sun, 1=Mon, ... 6=Sat)
const startOffset = (firstDay.getDay() + 6) % 7; // Convert to Mon-based

// Group content by day
const contentByDay: Map<number, typeof items> = new Map();
for (const item of items) {
  const d = item.data.publishDate ?? item.data.date;
  if (d.getFullYear() === year && d.getMonth() === month) {
    const day = d.getDate();
    if (!contentByDay.has(day)) contentByDay.set(day, []);
    contentByDay.get(day)!.push(item);
  }
}

// Weekly rhythm targets (Mon=X, Wed=X, Fri=X, Sat=YT)
const rhythmDays = new Set([1, 3, 5, 6]); // Mon=1, Wed=3, Fri=5, Sat=6 (0-indexed from Mon)

// Generate cells
const totalCells = startOffset + daysInMonth;
const rows = Math.ceil(totalCells / 7);
---

<BaseLayout title="SNS Calendar" description="Monthly content publishing calendar">
  <style>
    .cal-header {
      text-align: center;
      padding: 60px 0 24px;
    }
    .cal-header h1 {
      font-size: 28px;
      font-weight: 900;
      margin-bottom: 4px;
    }
    .cal-header .sub {
      font-size: 13px;
      color: var(--text-dim);
    }
    .cal-nav {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .cal-nav a {
      color: var(--cyan);
      text-decoration: none;
      font-size: 12px;
      padding: 6px 14px;
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: 16px;
      transition: all 0.15s;
    }
    .cal-nav a:hover {
      background: rgba(34, 211, 238, 0.06);
      border-color: var(--cyan);
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      max-width: 800px;
      margin: 0 auto;
    }
    .cal-day-header {
      text-align: center;
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 8px 0;
    }
    .cal-cell {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      min-height: 80px;
      padding: 6px;
      position: relative;
    }
    .cal-cell.empty {
      background: transparent;
      border-color: transparent;
    }
    .cal-cell.today {
      border-color: var(--cyan);
      box-shadow: 0 0 8px rgba(34, 211, 238, 0.15);
    }
    .cal-cell.has-content {
      background: var(--bg-raised);
    }
    .cal-cell.rhythm-day:not(.has-content) {
      border-style: dashed;
      border-color: rgba(245, 158, 11, 0.3);
    }
    .cal-day-num {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .cal-items {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .cal-item {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 9px;
      padding: 2px 4px;
      border-radius: 3px;
      color: var(--text);
      text-decoration: none;
      transition: background 0.1s;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .cal-item:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    .cal-item .icon {
      flex-shrink: 0;
    }
    .cal-item .label {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .legend-dash {
      width: 16px;
      height: 0;
      border-top: 1px dashed rgba(245, 158, 11, 0.5);
    }

    .footer {
      text-align: center;
      padding: 48px 0;
      font-size: 10px;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .cal-cell {
        min-height: 60px;
        padding: 4px;
      }
      .cal-day-num {
        font-size: 10px;
      }
      .cal-item {
        font-size: 8px;
      }
      .cal-item .label {
        display: none;
      }
    }
  </style>

  <div class="container">
    <div class="cal-header">
      <a href="/knowledge-base/sns/" class="back-link" style="font-size: 12px;">&larr; SNS Portal</a>
      <h1 class="text-gradient">{monthNames[month]} {year}</h1>
      <p class="sub">Content Publishing Calendar</p>
    </div>

    <div class="cal-nav">
      <a href="/knowledge-base/sns/">Dashboard</a>
      <a href="/knowledge-base/">Knowledge Base</a>
    </div>

    <div class="cal-grid">
      <!-- Day headers -->
      {dayNames.map(d => (
        <div class="cal-day-header">{d}</div>
      ))}

      <!-- Empty offset cells -->
      {Array.from({ length: startOffset }).map(() => (
        <div class="cal-cell empty"></div>
      ))}

      <!-- Day cells -->
      {Array.from({ length: daysInMonth }).map((_, i) => {
        const day = i + 1;
        const dayContent = contentByDay.get(day) ?? [];
        const hasContent = dayContent.length > 0;
        const isToday = day === now.getDate() && month === now.getMonth() && year === now.getFullYear();
        const dayOfWeek = (startOffset + i) % 7; // 0=Mon, 6=Sun
        const isRhythmDay = rhythmDays.has(dayOfWeek);

        return (
          <div class={`cal-cell ${hasContent ? 'has-content' : ''} ${isToday ? 'today' : ''} ${isRhythmDay && !hasContent ? 'rhythm-day' : ''}`}>
            <div class="cal-day-num">{day}</div>
            <div class="cal-items">
              {dayContent.map(item => {
                const typeDef = getContentTypeDef(item.data.contentType);
                const slug = item.id.replace(/\.md$/, '');
                return (
                  <a href={`/knowledge-base/sns/${slug}/`} class="cal-item" title={item.data.title}>
                    <span class="icon" style={`color: ${typeDef.color}`}>{typeDef.icon}</span>
                    <span class="label">{item.data.title}</span>
                  </a>
                );
              })}
            </div>
          </div>
        );
      })}
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background: #1DA1F2;"></div> X Post</div>
      <div class="legend-item"><div class="legend-dot" style="background: #FF0000;"></div> YouTube</div>
      <div class="legend-item"><div class="legend-dot" style="background: #d4782f;"></div> Article</div>
      <div class="legend-item"><div class="legend-dot" style="background: #f59e0b;"></div> Idea</div>
      <div class="legend-item"><div class="legend-dash"></div> Rhythm day (target)</div>
    </div>

    <div class="footer">SNS Portal â€” Calendar View</div>
  </div>
</BaseLayout>
