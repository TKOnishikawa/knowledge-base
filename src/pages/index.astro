---
import BaseLayout from '../layouts/BaseLayout.astro';
import Search from '../components/Search.astro';
import { getPublishedArticles } from '../utils/collections';
import { taxonomy, getCategoryDef } from '../data/taxonomy';

const articles = await getPublishedArticles();
const categories = Object.entries(taxonomy);

const maturityConfig: Record<string, { label: string; color: string }> = {
  seed: { label: 'SEED', color: '#f59e0b' },
  memo: { label: 'MEMO', color: '#22d3ee' },
  draft: { label: 'DRAFT', color: '#a78bfa' },
};
---

<BaseLayout title="Knowledge Base" description="AI-powered personal knowledge portal">
  <style>
    .hero {
      text-align: center;
      padding: 80px 0 40px;
    }
    .hero h1 {
      font-size: 36px;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .hero .sub {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 40px;
    }

    .filter-bar {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 40px;
    }
    .filter-btn {
      padding: 6px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: transparent;
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: var(--font-sans);
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--cyan);
      color: var(--cyan);
      background: rgba(34, 211, 238, 0.06);
    }

    .article-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 700px;
      margin: 0 auto;
    }
    .article-card {
      display: block;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.15s;
    }
    .article-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .card-eyebrow {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .card-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .card-meta {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .card-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .card-tag {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
    }

    .empty {
      text-align: center;
      padding: 60px;
      color: var(--text-muted);
    }

    .footer {
      text-align: center;
      padding: 60px 0;
      font-size: 10px;
      color: var(--text-muted);
    }

    .stats {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-bottom: 32px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .stats .num {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    /* Maturity filter */
    .maturity-bar {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-bottom: 12px;
    }
    .maturity-btn {
      padding: 4px 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s;
      font-family: var(--font-sans);
    }
    .maturity-btn:hover, .maturity-btn.active {
      border-color: var(--btn-color, var(--cyan));
      color: var(--btn-color, var(--cyan));
      background: rgba(34, 211, 238, 0.06);
    }

    /* Maturity badge on cards */
    .maturity-badge {
      display: inline-block;
      font-size: 9px;
      font-weight: 800;
      letter-spacing: 1.5px;
      padding: 2px 8px;
      border-radius: 3px;
      margin-left: 8px;
      vertical-align: middle;
    }
  </style>

  <div class="container">
    <div class="hero">
      <div class="badge">Knowledge Base</div>
      <h1 class="text-gradient">Knowledge Base</h1>
      <p class="sub">AI-powered personal knowledge portal</p>
    </div>

    <div class="stats">
      <div><span class="num">{articles.length}</span> articles</div>
      <div><span class="num">{new Set(articles.map(a => a.data.category)).size}</span> categories</div>
    </div>

    <div style="text-align: center; margin-bottom: 28px;">
      <a href="/knowledge-base/sns/" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; border: 1px solid rgba(34, 211, 238, 0.2); border-radius: 20px; color: var(--cyan); text-decoration: none; font-size: 12px; font-weight: 600; transition: all 0.15s;"
         onmouseover="this.style.background='rgba(34,211,238,0.06)'; this.style.borderColor='var(--cyan)'"
         onmouseout="this.style.background='transparent'; this.style.borderColor='rgba(34,211,238,0.2)'">
        SNS Portal &rarr;
      </a>
    </div>

    <Search />

    <div class="maturity-bar">
      <button class="maturity-btn active" data-maturity="all" style="--btn-color: var(--cyan)">All</button>
      <button class="maturity-btn" data-maturity="seed" style="--btn-color: #f59e0b">Seed</button>
      <button class="maturity-btn" data-maturity="memo" style="--btn-color: #22d3ee">Memo</button>
      <button class="maturity-btn" data-maturity="draft" style="--btn-color: #a78bfa">Draft</button>
      <button class="maturity-btn" data-maturity="published" style="--btn-color: #34d399">Article</button>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-category="all">All</button>
      {categories.map(([key, cat]) => (
        <button class="filter-btn" data-category={key} style={`--cat-color: ${cat.color}`}>
          {cat.labelJa}
        </button>
      ))}
    </div>

    <div class="article-grid" id="articles">
      {articles.length === 0 && (
        <div class="empty">No articles yet</div>
      )}
      {articles.map((article) => {
        const catDef = getCategoryDef(article.data.category);
        const dateStr = article.data.date.toISOString().split('T')[0];
        const maturity = article.data.maturity ?? 'published';
        const mConf = maturityConfig[maturity];
        return (
          <a href={`/knowledge-base/knowledge/${article.id.replace(/\.md$/, '')}/`} class="article-card" data-category={article.data.category} data-maturity={maturity}>
            <div class="card-eyebrow" style={`color: ${catDef.color}`}>
              {catDef.labelJa}
              {mConf && (
                <span class="maturity-badge" style={`color: ${mConf.color}; background: ${mConf.color}15; border: 1px solid ${mConf.color}40;`}>
                  {mConf.label}
                </span>
              )}
            </div>
            <div class="card-title">{article.data.title}</div>
            <div class="card-desc">{article.data.description}</div>
            <div class="card-meta">
              <span>{dateStr}</span>
              {article.data.series && <span>Series: {article.data.series}</span>}
            </div>
            <div class="card-tags">
              {article.data.tags.map((tag) => (
                <span class="card-tag">{tag}</span>
              ))}
            </div>
          </a>
        );
      })}
    </div>

    <div class="footer">TK Knowledge Base</div>
  </div>

  <script>
    let activeCategory = 'all';
    let activeMaturity = 'all';

    function applyFilters() {
      document.querySelectorAll('.article-card').forEach(card => {
        const el = card as HTMLElement;
        const cat = el.getAttribute('data-category');
        const mat = el.getAttribute('data-maturity');
        const matchCat = activeCategory === 'all' || cat === activeCategory;
        const matchMat = activeMaturity === 'all' || mat === activeMaturity;
        el.style.display = (matchCat && matchMat) ? '' : 'none';
      });
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = btn.getAttribute('data-category') ?? 'all';
        applyFilters();
      });
    });

    document.querySelectorAll('.maturity-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.maturity-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeMaturity = btn.getAttribute('data-maturity') ?? 'all';
        applyFilters();
      });
    });
  </script>
</BaseLayout>
