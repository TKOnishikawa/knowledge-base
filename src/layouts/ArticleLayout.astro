---
import BaseLayout from './BaseLayout.astro';
import { getCategoryDef } from '../data/taxonomy';
import type { CollectionEntry } from 'astro:content';

interface Props {
  article: CollectionEntry<'knowledge'>;
}

const { article } = Astro.props;
const { title, description, date, category, tags, updated, maturity, tools_mentioned } = article.data;
const categoryDef = getCategoryDef(category);
const formattedDate = date.toISOString().split('T')[0];
const formattedUpdated = updated?.toISOString().split('T')[0];

const maturityConfig: Record<string, { label: string; color: string }> = {
  seed: { label: 'SEED', color: '#f59e0b' },
  memo: { label: 'MEMO', color: '#22d3ee' },
  draft: { label: 'DRAFT', color: '#a78bfa' },
};
const mConf = maturityConfig[maturity ?? ''];
---

<BaseLayout title={title} description={description}>
  <style>
    @import '../styles/article.css';

    .maturity-label {
      display: inline-block;
      font-size: 9px;
      font-weight: 800;
      letter-spacing: 1.5px;
      padding: 2px 8px;
      border-radius: 3px;
      margin-left: 8px;
      vertical-align: middle;
    }
  </style>

  <div class="progress-bar" id="progress"></div>

  <div class="container">
    <a href="/knowledge-base/" class="back-link">← Knowledge Base</a>

    <header class="article-header">
      <div class="category-badge" style={`color: ${categoryDef.color}`}>
        {categoryDef.labelJa}
        {mConf && (
          <span class="maturity-label" style={`color: ${mConf.color}; background: ${mConf.color}15; border: 1px solid ${mConf.color}40;`}>
            {mConf.label}
          </span>
        )}
      </div>
      <h1>{title}</h1>
      <p style="color: var(--text-dim); margin-bottom: 16px;">{description}</p>
      <div class="article-meta">
        <span class="mono">{formattedDate}</span>
        {formattedUpdated && <span class="mono">Updated: {formattedUpdated}</span>}
        <span>{category}</span>
      </div>
      <div class="article-tags">
        {tags.map((tag) => (
          <a href={`/knowledge-base/tags/${tag}/`} class="tag">{tag}</a>
        ))}
      </div>
    </header>

    <article class="article-body" data-pagefind-body>
      <div data-pagefind-meta={`title:${title}`} data-pagefind-filter={`category:${category}`} data-pagefind-filter={`maturity:${maturity ?? 'published'}`}></div>
      {tags.map((tag) => (
        <span data-pagefind-meta={`tag:${tag}`} style="display:none;"></span>
      ))}
      {tools_mentioned?.map((tool) => (
        <span data-pagefind-meta={`tool:${tool}`} style="display:none;"></span>
      ))}
      <slot />
    </article>

    <footer style="padding: 60px 0; text-align: center; color: var(--text-muted); font-size: 12px;">
      <a href="/knowledge-base/" class="back-link">← Back to Knowledge Base</a>
    </footer>
  </div>

  <script>
    // Scroll progress bar
    window.addEventListener('scroll', () => {
      const bar = document.getElementById('progress');
      if (!bar) return;
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      bar.style.width = docHeight > 0 ? `${(scrollTop / docHeight) * 100}%` : '0%';
    });
  </script>
</BaseLayout>
